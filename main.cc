#include <iostream>
#include <pcap.h>
#include <stdio.h>
#include <stdlib.h>
#include <memory>
#include <cstring>
#include <netinet/ether.h>
#include <netinet/ip.h>
#include <netinet/tcp.h>
#include <netinet/udp.h>
#include <chrono>

#define UDP_HEADER_LEN 8
static uint16_t base_ip_id = 1;

void dump_packet(pcap_dumper_t* dumper, bool uplink, std::string data) {
  // 构造数据包内容
  struct pcap_pkthdr header;

  int total_size = sizeof(struct ether_header) + sizeof(struct iphdr) +
                   UDP_HEADER_LEN + data.length();

  u_char buffer[total_size] = {0};

  struct ether_header* eth_hdr = reinterpret_cast<struct ether_header*>(buffer);
  eth_hdr->ether_type = htons(ETH_P_IP);

  struct iphdr* ip_header =
      reinterpret_cast<struct iphdr*>(buffer + sizeof(struct ether_header));
  memset(ip_header, 0, sizeof(struct iphdr));
  // Fill in the required fields
  ip_header->ihl = 5;  // Header length in 32-bit words (5 * 4 bytes = 20 bytes)
  ip_header->version = 4;  // IPv4
  ip_header->tos = 0;      // Type of Service
  ip_header->tot_len = htons(sizeof(struct iphdr) + UDP_HEADER_LEN +
                             data.length());  // Total length (header + data)
  ip_header->id = htons(base_ip_id++);        // Identification field
  ip_header->frag_off = htons(0x4000);        // Fragmentation flags and offset
  ip_header->ttl = 64;                        // Time to live
  ip_header->protocol =
      IPPROTO_UDP;       // Protocol (e.g., IPPROTO_TCP, IPPROTO_UDP)
  ip_header->check = 0;  // Fill in later
  if (uplink) {
    ip_header->saddr = inet_addr("192.168.0.1");  // Source IP address
    ip_header->daddr = inet_addr("192.168.0.2");  // Destination IP address
  } else {
    ip_header->saddr = inet_addr("192.168.0.2");  // Source IP address
    ip_header->daddr = inet_addr("192.168.0.1");  // Destination IP address
  }

  // 构造UDP包
  struct udphdr* udp_header = reinterpret_cast<struct udphdr*>(
      buffer + sizeof(struct ether_header) + sizeof(struct iphdr));

  if (uplink) {
    udp_header->source = htons(1234);  // 源端口
    udp_header->dest = htons(4321);    // 目标端口
  } else {
    udp_header->source = htons(4321);  // 源端口
    udp_header->dest = htons(1234);    // 目标端口
  }
  udp_header->len = htons(UDP_HEADER_LEN + data.length());  // 长度
  udp_header->check = 0;  // 检验和（可以忽略）

  u_char* udp_data =
      reinterpret_cast<u_char*>(buffer + sizeof(struct ether_header) +
                                sizeof(struct iphdr) + sizeof(struct udphdr));
  memcpy(udp_data, data.c_str(), data.length());

  auto now = std::chrono::system_clock::now();
  header.len = total_size;
  header.caplen = total_size;
  gettimeofday(&header.ts, nullptr);

  pcap_dump((u_char*)dumper, &header, buffer);  // 将数据包写入文件
}

int main() {
  pcap_t* handle;
  char errbuf[PCAP_ERRBUF_SIZE];

  handle = pcap_open_dead(DLT_EN10MB, BUFSIZ);  // 创建pcap文件
  // handle = pcap_open_offline("example.pcap", errbuf);  // 打开pcap文件
  // if (handle == NULL) {
  //   fprintf(stderr, "Couldn't open pcap file: %s\n", errbuf);
  //   exit(1);
  // }
  pcap_dumper_t* dumper;
  dumper = pcap_dump_open(handle, "example.pcap");
  if (dumper == NULL) {
    fprintf(stderr, "Couldn't open pcap file for writing\n");
    exit(1);
  }

  auto hexstr2data = [](std::string hexstr) {
    std::string data;
    data.resize(hexstr.length() / 2);

    auto convert = [](char ch) {
      if (ch >= '0' && ch <= '9') {
        return ch - '0';
      }
      return ch - 'a' + 10;
    };

    for (int i = 0; i < hexstr.length() / 2; i++) {
      uint8_t h = convert(hexstr.c_str()[i * 2]);
      uint8_t l = convert(hexstr.c_str()[i * 2 + 1]);

      data.data()[i] = (h << 4) | l;
    }
    return data;
  };

  auto tmp = hexstr2data("1a2b3c");
  printf("%ld %02x %02x %02x\n", tmp.size(),
         static_cast<uint8_t>(tmp.c_str()[0]),
         static_cast<uint8_t>(tmp.c_str()[1]),
         static_cast<uint8_t>(tmp.c_str()[2]));
#define bad_core 1
#if bad_core
  dump_packet(
      dumper, true,
      hexstr2data(
          "16fefd0000000000000000012d010001210000000000000121fefde2b29d6245b8fb"
          "08ad2e4baefeb5faf4b2f62702d12cd94ca090059687febe8500000096c02cc03000"
          "a3009fcca9cca8ccaac0afc0adc0a3c09fc05dc061c057c053c024c028006b006ac0"
          "73c07700c400c3c00ac0140039003800880087009dc0a1c09dc051003d00c0003500"
          "84c02bc02f00a2009ec0aec0acc0a2c09ec05cc060c056c052c023c02700670040c0"
          "72c07600be00bdc009c01300330032009a009900450044009cc0a0c09cc050003c00"
          "ba002f0096004100ff01000061000b000403000102000a000c000a001d0017001e00"
          "19001800230000000e000500020001000016000000170000000d0030002e04030503"
          "0603080708080809080a080b08040805080604010501060103030203030102010302"
          "0202040205020602"));
  dump_packet(
      dumper, false,
      hexstr2data(
          "16fefd00000000000000000063020000570000000000000057fefdc4066034b45bad"
          "01daa6eb941ec48c1671903b8f9bc5449f739b0e59b452510520bfa5131ec0739dea"
          "e41f611c2bfda60f32d3b858bd265ae79f1b3bb18404e171c02b00000f000b000201"
          "0000170000ff0100010016fefd0000000000000001015d0b00015100010000000001"
          "5100014e00014b308201473081eda003020102020500e4d64946300a06082a8648ce"
          "3d040302302b31293027060355040313206433626363303536343665333236646234"
          "303230636563363739666135626566301e170d3233313231373131303431305a170d"
          "3234303131373131303431305a302b31293027060355040313206433626363303536"
          "3436653332366462343032306365633637396661356265663059301306072a8648ce"
          "3d020106082a8648ce3d0301070342000410dfb7e84119999be8456f7b49843ba242"
          "597efc5827da09eece4bbb54d5fb6adac73947ef1c7e3a09a518d747b44e913bf71e"
          "5994e77412c88a2950921843f1300a06082a8648ce3d0403020349003046022100ba"
          "d2105e64371c1bf1ccce3d6363a328a4323058ee865f169bce01c69a06e508022100"
          "d9ecaaadbb9951136bf836665bc86fb9d24374e00a3e0f3b3c6095b4cbc75f9b16fe"
          "fd0000000000000002007c0c000070000200000000007003001d206021b20dd5303e"
          "e3dbbdfecdfd06c3937051b895b31f0525c1e86d680c6d8a08040300483046022100"
          "a6532337c390d94987c63e74fe3c4e6f5e4f944cc524b9dc5a0465c4fa0192230221"
          "00b0e125716cd29a5409e9bff6f75758d63be56b9f27f8e00cb63ab6737d8b989516"
          "fefd000000000000000300320d000026000300000000002603014002001e04030503"
          "0603020308040805080604010501060102010402050206020202000016fefd000000"
          "0000000004000c0e0000000004000000000000"));
  dump_packet(
      dumper, true,
      hexstr2data(
          "16fefd000000000000000101d70b0001cb00010000000001cb0001c80001c5308201"
          "c13082012aa00302010202040851fb92300d06092a864886f70d0101050500302531"
          "23302106035504030c1a7369703a7369703a6d61726b6574696e674061676f72612e"
          "696f301e170d3233313230353036303533345a170d3234313230343036303533345a"
          "30253123302106035504030c1a7369703a7369703a6d61726b6574696e674061676f"
          "72612e696f30819f300d06092a864886f70d010101050003818d0030818902818100"
          "b9aa1d0040f9feb3c4af83a834ce3d65dfb3b917494bbe7b9b99727b0976869fa80e"
          "2e70c37b2052396a6258477ec541cf434cafac4a88ebb13e49ddacaa396312ef637e"
          "1967bff3453e96ce8188359e48c5ee73eb04b2ccbaffb090565b2a270776992bc76c"
          "861d097bcd10634a491ec57bae025789505ba42219eaa2c37c9b0203010001300d06"
          "092a864886f70d010105050003818100746237ceff044210a8bc3085a8089e2619f2"
          "742d1028b1e906af82ca9e06e9a2f4dc9bad21a2b11f694fb165f266de91f63db33f"
          "99518117298fb9e47d68b1bea4f4c48c5369573efe3c5c36ec2ddaf54478ee572e2d"
          "a36ec7d6871d48b58703e7b7ddaf5be995b3da50b1f9167d0ab2990d9938c0776200"
          "082d17b8202fdc3016fefd0000000000000002002d10000021000200000000002120"
          "bbb0630aef2f3470decc192ed20a870e737609eca251a1076adec9ee5c0fb04816fe"
          "fd000000000000000300900f00008400030000000000840804008018ff116012c8bc"
          "8c7cfeb4b2753e360e4e42b7316d25a3a25f38024810d529e1580712c3667be6ed47"
          "843799bb0c0f2a4402e25221bf2d65a0f30542b1035b3985d46935d880af47292747"
          "9dae5ebe537294b2850889f74a73a2c4d2d171b66fd9dd039112c94b88d11e1dea64"
          "395512ef6ed46d4a7447f4cdb2f6cbaea17efe14fefd000000000000000400010116"
          "fefd00010000000000000030e482d1cb38ff16bbd5ad2d17bc01632b6571574b5d1b"
          "186301e6252076dc01ceca74554575b4f4099a7b3a0f6b586b3c"));
  dump_packet(
      dumper, false,
      hexstr2data(
          "16fefd00000000000000050063020000570000000000000057fefdc4066034b45bad"
          "01daa6eb941ec48c1671903b8f9bc5449f739b0e59b452510520bfa5131ec0739dea"
          "e41f611c2bfda60f32d3b858bd265ae79f1b3bb18404e171c02b00000f000b000201"
          "0000170000ff0100010016fefd0000000000000006015d0b00015100010000000001"
          "5100014e00014b308201473081eda003020102020500e4d64946300a06082a8648ce"
          "3d040302302b31293027060355040313206433626363303536343665333236646234"
          "303230636563363739666135626566301e170d3233313231373131303431305a170d"
          "3234303131373131303431305a302b31293027060355040313206433626363303536"
          "3436653332366462343032306365633637396661356265663059301306072a8648ce"
          "3d020106082a8648ce3d0301070342000410dfb7e84119999be8456f7b49843ba242"
          "597efc5827da09eece4bbb54d5fb6adac73947ef1c7e3a09a518d747b44e913bf71e"
          "5994e77412c88a2950921843f1300a06082a8648ce3d0403020349003046022100ba"
          "d2105e64371c1bf1ccce3d6363a328a4323058ee865f169bce01c69a06e508022100"
          "d9ecaaadbb9951136bf836665bc86fb9d24374e00a3e0f3b3c6095b4cbc75f9b16fe"
          "fd0000000000000007007c0c000070000200000000007003001d206021b20dd5303e"
          "e3dbbdfecdfd06c3937051b895b31f0525c1e86d680c6d8a08040300483046022100"
          "a6532337c390d94987c63e74fe3c4e6f5e4f944cc524b9dc5a0465c4fa0192230221"
          "00b0e125716cd29a5409e9bff6f75758d63be56b9f27f8e00cb63ab6737d8b989516"
          "fefd000000000000000800320d000026000300000000002603014002001e04030503"
          "0603020308040805080604010501060102010402050206020202000016fefd000000"
          "0000000009000c0e0000000004000000000000"));
  dump_packet(
      dumper, true,
      hexstr2data(
          "16fefd000000000000000101d70b0001cb00010000000001cb0001c80001c5308201"
          "c13082012aa00302010202040851fb92300d06092a864886f70d0101050500302531"
          "23302106035504030c1a7369703a7369703a6d61726b6574696e674061676f72612e"
          "696f301e170d3233313230353036303533345a170d3234313230343036303533345a"
          "30253123302106035504030c1a7369703a7369703a6d61726b6574696e674061676f"
          "72612e696f30819f300d06092a864886f70d010101050003818d0030818902818100"
          "b9aa1d0040f9feb3c4af83a834ce3d65dfb3b917494bbe7b9b99727b0976869fa80e"
          "2e70c37b2052396a6258477ec541cf434cafac4a88ebb13e49ddacaa396312ef637e"
          "1967bff3453e96ce8188359e48c5ee73eb04b2ccbaffb090565b2a270776992bc76c"
          "861d097bcd10634a491ec57bae025789505ba42219eaa2c37c9b0203010001300d06"
          "092a864886f70d010105050003818100746237ceff044210a8bc3085a8089e2619f2"
          "742d1028b1e906af82ca9e06e9a2f4dc9bad21a2b11f694fb165f266de91f63db33f"
          "99518117298fb9e47d68b1bea4f4c48c5369573efe3c5c36ec2ddaf54478ee572e2d"
          "a36ec7d6871d48b58703e7b7ddaf5be995b3da50b1f9167d0ab2990d9938c0776200"
          "082d17b8202fdc3016fefd0000000000000002002d10000021000200000000002120"
          "bbb0630aef2f3470decc192ed20a870e737609eca251a1076adec9ee5c0fb04816fe"
          "fd000000000000000300900f00008400030000000000840804008018ff116012c8bc"
          "8c7cfeb4b2753e360e4e42b7316d25a3a25f38024810d529e1580712c3667be6ed47"
          "843799bb0c0f2a4402e25221bf2d65a0f30542b1035b3985d46935d880af47292747"
          "9dae5ebe537294b2850889f74a73a2c4d2d171b66fd9dd039112c94b88d11e1dea64"
          "395512ef6ed46d4a7447f4cdb2f6cbaea17efe14fefd000000000000000400010116"
          "fefd00010000000000000030e482d1cb38ff16bbd5ad2d17bc01632b6571574b5d1b"
          "186301e6252076dc01ceca74554575b4f4099a7b3a0f6b586b3c"));
  dump_packet(
      dumper, false,
      hexstr2data(
          "16fefd000000000000000a0063020000570000000000000057fefdc4066034b45bad"
          "01daa6eb941ec48c1671903b8f9bc5449f739b0e59b452510520bfa5131ec0739dea"
          "e41f611c2bfda60f32d3b858bd265ae79f1b3bb18404e171c02b00000f000b000201"
          "0000170000ff0100010016fefd000000000000000b015d0b00015100010000000001"
          "5100014e00014b308201473081eda003020102020500e4d64946300a06082a8648ce"
          "3d040302302b31293027060355040313206433626363303536343665333236646234"
          "303230636563363739666135626566301e170d3233313231373131303431305a170d"
          "3234303131373131303431305a302b31293027060355040313206433626363303536"
          "3436653332366462343032306365633637396661356265663059301306072a8648ce"
          "3d020106082a8648ce3d0301070342000410dfb7e84119999be8456f7b49843ba242"
          "597efc5827da09eece4bbb54d5fb6adac73947ef1c7e3a09a518d747b44e913bf71e"
          "5994e77412c88a2950921843f1300a06082a8648ce3d0403020349003046022100ba"
          "d2105e64371c1bf1ccce3d6363a328a4323058ee865f169bce01c69a06e508022100"
          "d9ecaaadbb9951136bf836665bc86fb9d24374e00a3e0f3b3c6095b4cbc75f9b16fe"
          "fd000000000000000c007c0c000070000200000000007003001d206021b20dd5303e"
          "e3dbbdfecdfd06c3937051b895b31f0525c1e86d680c6d8a08040300483046022100"
          "a6532337c390d94987c63e74fe3c4e6f5e4f944cc524b9dc5a0465c4fa0192230221"
          "00b0e125716cd29a5409e9bff6f75758d63be56b9f27f8e00cb63ab6737d8b989516"
          "fefd000000000000000d00320d000026000300000000002603014002001e04030503"
          "0603020308040805080604010501060102010402050206020202000016fefd000000"
          "000000000e000c0e0000000004000000000000"));
#endif
#if normal
  dump_packet(
      dumper, true,
      hexstr2data(
          "16fefd0000000000000000012d010001210000000000000121fefd7763b07a5af9a6"
          "02e928e97a8d4c3075796a0b06ff4a2e116e856bb79a0167a900000096c02cc03000"
          "a3009fcca9cca8ccaac0afc0adc0a3c09fc05dc061c057c053c024c028006b006ac0"
          "73c07700c400c3c00ac0140039003800880087009dc0a1c09dc051003d00c0003500"
          "84c02bc02f00a2009ec0aec0acc0a2c09ec05cc060c056c052c023c02700670040c0"
          "72c07600be00bdc009c01300330032009a009900450044009cc0a0c09cc050003c00"
          "ba002f0096004100ff01000061000b000403000102000a000c000a001d0017001e00"
          "19001800230000000e000500020001000016000000170000000d0030002e04030503"
          "0603080708080809080a080b08040805080604010501060103030203030102010302"
          "0202040205020602"));
  dump_packet(
      dumper, false,
      hexstr2data(
          "16fefd00000000000000000050020000440000000000000044fefd6581058509c376"
          "491d50d6e43bbef9b85364b6b510e9d93605369ac2e0d44ca800cca900001c001700"
          "00ff01000100000b0002010000230000000e0005000200010016fefd000000000000"
          "0001012a0b00011e000100000000011e00011b000118308201143081bca003020102"
          "02080a1a6e715847b74e300a06082a8648ce3d0403023011310f300d06035504030c"
          "06576562525443301e170d3233313231383032353235325a170d3234303131383032"
          "353235325a3011310f300d06035504030c065765625254433059301306072a8648ce"
          "3d020106082a8648ce3d030107034200047efb2ee04e80624eddcd34c2dab4816736"
          "e317399fc7c833a697a772c4f739c485b15989f7f6a8431b444dc202715851a575c2"
          "9f86e47234afcbfb3abb5f6857300a06082a8648ce3d040302034700304402207057"
          "5c6de851b203249128adfcb534544dacb662ee97f9693e6460ce37382bb802202a5c"
          "2cae51e65027b70483515498e57466c3665de35d5d260de2e458d7131bd016fefd00"
          "00000000000002007a0c00006e000200000000006e03001d20eb8edfb92769240292"
          "5bf481e874e4f8904d935c3b3053c422775859c6f36d74040300463044022051095e"
          "f90c21b337f112317a031c5cc515d23d2c3f40d72f2d7d48503b9eb78102202cbb68"
          "cbe0e3149409f68fafbfa6b10f4765c53ff6cca883d454865960bf37d016fefd0000"
          "00000000000300250d00001900030000000000190201400012040308040401050308"
          "050501080606010201000016fefd0000000000000004000c0e000000000400000000"
          "0000"));
  dump_packet(
      dumper, true,
      hexstr2data(
          "16fefd000000000000000101d70b0001cb00010000000001cb0001c80001c5308201"
          "c13082012aa00302010202045e780a09300d06092a864886f70d0101050500302531"
          "23302106035504030c1a7369703a7369703a6d61726b6574696e674061676f72612e"
          "696f301e170d3233313230373033313032345a170d3234313230363033313032345a"
          "30253123302106035504030c1a7369703a7369703a6d61726b6574696e674061676f"
          "72612e696f30819f300d06092a864886f70d010101050003818d0030818902818100"
          "c93f96e479052adc53f3e1f1e34b7e1ab28670d8770e7ea63a63ab10f0abab0c593e"
          "e4fbadc83f1461bb8fb43f659c3e6f8c67b824caef041a337c9f9aa3f1e14fc470f8"
          "f7e75146c953c92c5e4688f8c7e132cdf6b1ea4a20058cbea56aaf69320a8c7b5fb6"
          "df8a4bba30f8865941778aef5f316847de269f3cfca9b8fb25470203010001300d06"
          "092a864886f70d0101050500038181005b4cc7d24d661304ef2cdb3764c97f62d9d6"
          "89d6a53020e69f1d1e06654ade5eb97f8961f0f12f0205967680d74f6228a7778ca0"
          "ae0a85fbc3e15c16563ce62c44b3895a9bf3db7037bb4d0d59d66c10cd487e89426b"
          "d19dd5e3d763880334a0f53c45fe15ec10e20cdc4b16a5a08741e0faaa3de7e12f4e"
          "74891bb9baaff0b016fefd0000000000000002002d10000021000200000000002120"
          "976ec8e51e066e4ab47394c4e0ec4aeff5a3d763ebdfb19f39a91c19578bc23016fe"
          "fd000000000000000300900f000084000300000000008408040080c6f8921e07ec1e"
          "475fc82b1d47429eac595db451e40d4edb4879746e4e84a7ba8fe2222b1784c624bc"
          "1ac43588bc04736c74a7dc404bb9ae976e067bf9ccfb2df0caf6cf714c80dfc43e24"
          "4c01e0e66e9a4189dfae76848bc06f059b064f6a7982e3d6acf39ad326d46c12ff0d"
          "867eea5a946975caa5830b8ee02c8d9030685a14fefd000000000000000400010116"
          "fefd00010000000000000028756c496440d50a0b1044d0285a45018b77add9176f77"
          "71801f9234f7c72db3a67ed6878865cc2a5b"));
  dump_packet(
      dumper, false,
      hexstr2data(
          "16fefd0000000000000005028204000276000500000000027600001c20027049f160"
          "cdcfb50e3f33917cbe07e86e57da811d0326e79d95051ecf3d89e9a0cb70bc33249a"
          "0381360ca2694a295beb20ac567f88cb13fb5e6cfe0281fb0e9c5850349e3fe313e9"
          "dc4d3e98dfcf82d84f32f7ea4928d1dbbcc68ee04bc1cd388ffe7ff00acb1d674ad4"
          "0625427f21c73165af088da58dd21eb0600ee60b481db6af3d6d33b1668ccb1b39f4"
          "d01a1367bf25e4d4f233d81f8cef7b010802f1354f58356c8bf943cc75bbb1d02d42"
          "e656c14c5030ffc29a96bcf420586393d2ed410be25223ab7b436e32fc66bf9d79ea"
          "d8bef5e5b977772452e83ed75dbddf96d147f5f243259e22183bd6307ae52e73193e"
          "a817b578cce750294f881326c4a77b8726f46240b4c6da47c42ce510de9ec56914ad"
          "2e9771d465f7e58e97c2ca77d79657be51161f45cc3f47725c0d00462ced7b7397a3"
          "d75cf292efeed298b9393732b0aef19e752096ab872a28bd63198be34fa99e9e0a1b"
          "7a3dd8e14e06b6e716c82f7c5f2cf554fcaf5e6f2596c9bc98941480ef4d8a05800e"
          "d00bbfb593eff459408615472c5dd154c474e594a0bc61bec01ca31d35b295567507"
          "ad277e522d98fc59146c9d07d51e18dec4c8f41628d0f885eca76ee6621745df4410"
          "8178f40bdb4f9cea8abe9f5eb9b300e194a5a6ca887fee678f257a9f20c6df1390ea"
          "0f3460a3dd5ea7737063aa24151920c8f931f956939943ed6d652afe947b199260f0"
          "ac9df2045d13557ac40633456527b9b20abc857dcc51bbd3ed040abd8ec657cef234"
          "70d622612d400ea24daf6f2301c254bac4e63bfc78527775db2195beb7af7c67d6f3"
          "bf8124ddd97e36dcf64cba50d5ceeb5d2667e68bcfce7656d57b78ea342685380bd4"
          "bdc8545c72c4d8cc7314fefd000000000000000600010116fefd0001000000000000"
          "0028a288f2b6092e083feb99542d35dd85f6b8cf7e17a46e4e0197cdb399cb82d1a6"
          "c86e88db40dd829c"));
#endif
  pcap_dump_close(dumper);  // 关闭写入pcap文件的句柄
  pcap_close(handle);       // 关闭pcap文件
  return 0;
}